/*
 * checkout.js - Shopp catalog behaviors library
 * Copyright ?? 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(){var c=jqnc(),j=false,r=c("#same-shipping"),b=c("#submit-login-checkout"),k=c("#account-login-checkout"),g=c("#password-login-checkout"),h=c("#checkout.shopp"),o=c("#shipping-address-fields"),l=c("#billing-address-fields"),n=c("#checkout.shopp [name=paymethod]"),a=c("#billing-locale"),p=c("#billing-card"),m=c("#billing-cardtype"),s=c(".payoption-button"),f=c("#checkout.shopp li.locale");if(h.find("input[name=checkout]").val()=="process"){if(n.length==0){e(false,d_pm)}else{n.change(e).change()}}h.bind("shopp_validate",function(){if(!d()){this.shopp_validate=["Not a valid card number.",p.get(0)]}});p.change(d);m.change(function(){var u=m.val(),t=paycards[u.toLowerCase()];c(".paycard.xcsc").attr("disabled",true).addClass("disabled");if(!t||!t.inputs){return}c.each(t.inputs,function(v,w){c("#billing-xcsc-"+v).attr("disabled",false).removeClass("disabled")})}).change();if(a.children().size()==0){f.hide()}c.fn.setDisabled=function(t){c(this).each(function(){if(t){c(this).attr("disabled",true).addClass("disabled")}else{c(this).attr("disabled",false).removeClass("disabled")}});return c(this)};b.click(function(){j=true});h.unbind("submit").submit(function(){if(j){if(k.val()==""){alert(sjss.LOGIN_NAME_REQUIRED);k.focus();j=false;return false}if(g.val()==""){alert(sjss.LOGIN_PASSWORD_REQUIRED);g.focus();j=false;return false}c("#process-login").val("true");return true}if(validate(this)){return true}else{return false}});c("#billing-country,#shipping-country").change(function(w,z){var v=c(this).attr("id").split("-")[0],y=c(this).val(),u=c("#"+v+"-state"),x=c("#"+v+"-state-menu"),t='<option value=""></option>';if(x.length==0){return true}if(x.hasClass("hidden")){x.removeClass("hidden").hide()}if(regions[y]||(z&&x.find("option").length>1)){u.setDisabled(true).hide();if(regions[y]){c.each(regions[y],function(B,A){t+='<option value="'+B+'">'+A+"</option>"});if(!z){x.empty().append(t).setDisabled(false).show().focus()}}x.setDisabled(false).show()}else{x.empty().setDisabled(true).hide();u.setDisabled(false).show();if(!z){u.val("").focus()}}}).trigger("change",[true]);c("#billing-country, .billing-state, #shipping-country, .shipping-state").change(function(x,z){var v=!r.is("#same-shipping")||r.is(":checked"),y=v?c("#billing-country").val():c("#shipping-country").val(),w=v?c('.billing-state[disabled!="true"]').val():c('.shipping-state[disabled!="true"]').val(),A=y+w,u,t;if(z||!a.get()||(!v&&(c(this).is("#billing-country")||c(this).is(".billing-state")))){return}a.empty().attr("disabled",true);if((t=locales[A])||(t=locales[y])){u+="<option></option>";c.each(t,function(C,B){u+='<option value="'+B+'">'+B+"</option>"});c(u).appendTo(a);a.removeAttr("disabled");f.show()}});r.change(function(t,u){if(r.is(":checked")){l.removeClass("half");o.hide().find(".required").setDisabled(true);c("#billing-country").trigger("change",[u])}else{l.addClass("half");o.show().find(".disabled").setDisabled(false);c("#shipping-country").trigger("change",[u]);if(!u){o.find("input:first").focus()}}}).trigger("change",[true]).click(function(){c(this).change()});c(".shopp .shipmethod").change(function(){if("process"==c("#checkout #shopp-checkout-function").val()){var x=".shopp_cart_",w="span"+x,u="input"+x,t=["shipping","tax","total"],v=[];c.each(t,function(z,y){v.push(w+y)});c(v.join(",")).html("?");c.getJSON(sjss.ajaxurl+"?action=shopp_ship_costs&method="+c(this).val(),function(y){c.each(t,function(A,z){c(w+z).html(asMoney(new Number(y[z])));c(u+z).val(new Number(y[z]))})})}else{c(this).parents("form").submit()}});c(window).load(function(){c(document).trigger("shopp_paymethod",[n.val()])});function e(y,w){if(!w){w=c(this).val()}var x=c(this),t=c(".payoption-"+w),v="",u=false;if(this!=window&&x.attr&&x.attr("type")=="radio"&&x.attr("checked")==false){return}c(document).trigger("shopp_paymethod",[w]);s.hide();if(t.length==0){t=c(".payoption-0")}if(pm_cards[w]&&pm_cards[w].length>0){h.find(".payment,.paycard").show();h.find(".paycard.disabled").attr("disabled",false).removeClass("disabled");if(typeof(paycards)!=="undefined"){c.each(pm_cards[w],function(z,A){if(!paycards[A]){return}u=paycards[A];v+='<option value="'+u.symbol+'">'+u.name+"</option>"});m.html(v).change()}}else{h.find(".payment,.paycard").hide();h.find(".paycard").attr("disabled",true).addClass("disabled")}t.show()}function d(){if(p.length==0){return true}if(p.attr("disabled")){return true}var t=p.val().replace(/\D/g,""),w=n.filter(":checked").val()?n.filter(":checked").val():n.val(),u=false;if(!w){w=d_pm}if(!pm_cards[w]){return true}c.each(pm_cards[w],function(v,y){var x=paycards[y],z=new RegExp(x.pattern.substr(1,x.pattern.length-2));if(t.match(z)){u=x.symbol;return m.val(u).change()}});if(!q(t)){return false}return u}function q(u){u=u.toString().replace(/\D/g,"").split("").reverse();if(!u.length){return false}var t=0;for(i=0;i<u.length;i++){u[i]=parseInt(u[i],10);t+=i%2?2*u[i]-(u[i]>4?9:0):u[i]}return(t%10)==0}});